load("@rules_cc//cc:defs.bzl", "cc_library")

package(default_visibility = ["//visibility:public"])

filegroup(
    name = "asn1_files",
    srcs = glob(["asn1/messages/*.asn1"]),
    visibility = ["//visibility:private"],
)

genrule(
    name = "gen_asn1_messages",
    outs = [
        "generated/AKCryptoSource.c",
        "generated/AKCryptoSource.h",
        "generated/AKDirectorMetaJson.c",
        "generated/AKDirectorMetaJson.h",
        "generated/AKDownloadOstreeRevReqMes.c",
        "generated/AKDownloadOstreeRevReqMes.h",
        "generated/AKDownloadOstreeRevRespMes.c",
        "generated/AKDownloadOstreeRevRespMes.h",
        "generated/AKFileName.c",
        "generated/AKFileName.h",
        "generated/AKFilePath.c",
        "generated/AKFilePath.h",
        "generated/AKGetInfoReqMes.c",
        "generated/AKGetInfoReqMes.h",
        "generated/AKGetInfoRespMes.c",
        "generated/AKGetInfoRespMes.h",
        "generated/AKIdentifier.c",
        "generated/AKIdentifier.h",
        "generated/AKImageMetaJson.c",
        "generated/AKImageMetaJson.h",
        "generated/AKInstallationResult.c",
        "generated/AKInstallationResultCode.c",
        "generated/AKInstallationResultCode.h",
        "generated/AKInstallationResult.h",
        "generated/AKInstallReqMes.c",
        "generated/AKInstallReqMes.h",
        "generated/AKInstallResp2Mes.c",
        "generated/AKInstallResp2Mes.h",
        "generated/AKInstallRespMes.c",
        "generated/AKInstallRespMes.h",
        "generated/AKIpUptaneKeyType.c",
        "generated/AKIpUptaneKeyType.h",
        "generated/AKIpUptaneMes.c",
        "generated/AKIpUptaneMes.h",
        "generated/AKManifestReqMes.c",
        "generated/AKManifestReqMes.h",
        "generated/AKManifestRespMes.c",
        "generated/AKManifestRespMes.h",
        "generated/AKMetaCollection.c",
        "generated/AKMetaCollection.h",
        "generated/AKMetaJson.c",
        "generated/AKMetaJson.h",
        "generated/AKPutMetaReq2Mes.c",
        "generated/AKPutMetaReq2Mes.h",
        "generated/AKPutMetaReqMes.c",
        "generated/AKPutMetaReqMes.h",
        "generated/AKPutMetaResp2Mes.c",
        "generated/AKPutMetaResp2Mes.h",
        "generated/AKPutMetaRespMes.c",
        "generated/AKPutMetaRespMes.h",
        "generated/AKPutRootReqMes.c",
        "generated/AKPutRootReqMes.h",
        "generated/AKPutRootRespMes.c",
        "generated/AKPutRootRespMes.h",
        "generated/AKRepoType.c",
        "generated/AKRepoType.h",
        "generated/AKRootVerReqMes.c",
        "generated/AKRootVerReqMes.h",
        "generated/AKRootVerRespMes.c",
        "generated/AKRootVerRespMes.h",
        "generated/AKSendFirmwareReqMes.c",
        "generated/AKSendFirmwareReqMes.h",
        "generated/AKSendFirmwareRespMes.c",
        "generated/AKSendFirmwareRespMes.h",
        "generated/AKTlsConfig.c",
        "generated/AKTlsConfig.h",
        "generated/AKUploadDataReqMes.c",
        "generated/AKUploadDataReqMes.h",
        "generated/AKUploadDataRespMes.c",
        "generated/AKUploadDataRespMes.h",
        "generated/AKUrl.c",
        "generated/AKUrl.h",
        "generated/AKVersionReqMes.c",
        "generated/AKVersionReqMes.h",
        "generated/AKVersionRespMes.c",
        "generated/AKVersionRespMes.h",
        "generated/asn_application.c",
        "generated/asn_application.h",
        "generated/asn_bit_data.c",
        "generated/asn_bit_data.h",
        "generated/asn_codecs.h",
        "generated/asn_codecs_prim.c",
        "generated/asn_codecs_prim.h",
        "generated/asn_internal.c",
        "generated/asn_internal.h",
        "generated/asn_ioc.h",
        "generated/asn_random_fill.c",
        "generated/asn_random_fill.h",
        "generated/asn_SEQUENCE_OF.c",
        "generated/asn_SEQUENCE_OF.h",
        "generated/asn_SET_OF.c",
        "generated/asn_SET_OF.h",
        "generated/asn_system.h",
        "generated/ber_decoder.c",
        "generated/ber_decoder.h",
        "generated/ber_tlv_length.c",
        "generated/ber_tlv_length.h",
        "generated/ber_tlv_tag.c",
        "generated/ber_tlv_tag.h",
        "generated/BIT_STRING.c",
        "generated/BIT_STRING.h",
        "generated/BIT_STRING_oer.c",
        "generated/constraints.c",
        "generated/constraints.h",
        "generated/constr_CHOICE.c",
        "generated/constr_CHOICE.h",
        "generated/constr_CHOICE_oer.c",
        "generated/constr_SEQUENCE.c",
        "generated/constr_SEQUENCE.h",
        "generated/constr_SEQUENCE_oer.c",
        "generated/constr_SEQUENCE_OF.c",
        "generated/constr_SEQUENCE_OF.h",
        "generated/constr_SET_OF.c",
        "generated/constr_SET_OF.h",
        "generated/constr_SET_OF_oer.c",
        "generated/constr_TYPE.c",
        "generated/constr_TYPE.h",
        "generated/der_encoder.c",
        "generated/der_encoder.h",
        "generated/INTEGER.c",
        "generated/INTEGER.h",
        "generated/INTEGER_oer.c",
        "generated/NativeEnumerated.c",
        "generated/NativeEnumerated.h",
        "generated/NativeEnumerated_oer.c",
        "generated/NativeInteger.c",
        "generated/NativeInteger.h",
        "generated/NativeInteger_oer.c",
        "generated/OCTET_STRING.c",
        "generated/OCTET_STRING.h",
        "generated/OCTET_STRING_oer.c",
        "generated/oer_decoder.c",
        "generated/oer_decoder.h",
        "generated/oer_encoder.c",
        "generated/oer_encoder.h",
        "generated/oer_support.c",
        "generated/oer_support.h",
        "generated/OPEN_TYPE.c",
        "generated/OPEN_TYPE.h",
        "generated/OPEN_TYPE_oer.c",
        "generated/per_decoder.c",
        "generated/per_decoder.h",
        "generated/per_encoder.c",
        "generated/per_encoder.h",
        "generated/per_opentype.c",
        "generated/per_opentype.h",
        "generated/per_support.c",
        "generated/per_support.h",
        "generated/UTF8String.c",
        "generated/UTF8String.h",
        "generated/VisibleString.c",
        "generated/VisibleString.h",
        "generated/xer_decoder.c",
        "generated/xer_decoder.h",
        "generated/xer_encoder.c",
        "generated/xer_encoder.h",
        "generated/xer_support.c",
        "generated/xer_support.h",
    ],
    cmd = "mkdir -p $(RULEDIR)/generated/ && $(location @asn1c) -no-gen-example -S `dirname $(location @asn1c//:skeletons_readme)` -D $(RULEDIR)/generated/ $(locations :asn1_files)",
    tools = [
        ":asn1_files",
        "@asn1c",
        "@asn1c//:skeletons",
        "@asn1c//:skeletons_readme",
    ],
)

cc_library(
    name = "asn1_messages",
    srcs = [
        ":gen_asn1_messages",
    ],
    includes = [
        "generated/",
    ],
    linkstatic = True,
    strip_include_prefix = "generated/",
)

cc_library(
    name = "asn1_lib",
    srcs = [
        "asn1/asn1-cer.cc",
        "asn1/asn1-cerstream.cc",
        "asn1/asn1_message.cc",
    ],
    hdrs = [
        "asn1/asn1-cer.h",
        "asn1/asn1-cerstream.h",
        "asn1/asn1_message.h",
    ],
    includes = [
        "asn1/",
    ],
    linkstatic = True,
    strip_include_prefix = "asn1/",
    deps = [
        ":asn1_messages",
        "//src/libaktualizr",
        "@boost//:intrusive_ptr",
    ],
)

cc_library(
    name = "aktualizr-posix",
    srcs = [
        "ipuptanesecondary.cc",
    ],
    hdrs = [
        "ipuptanesecondary.h",
    ],
    includes = [
        ".",
    ],
    linkstatic = True,
    deps = [
        ":asn1_lib",
        "//src/libaktualizr",
    ],
)
